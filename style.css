-- Entities with processing errors that haven't been updated in a long time
SELECT COUNT(*) 
FROM refresh_state 
WHERE errors IS NOT NULL 
  AND next_update_at < NOW() - INTERVAL '30 days'
  AND last_discovery_at < NOW() - INTERVAL '30 days';-- Find entities that haven't been attempted in a long time and are not scheduled for a future update.
SELECT COUNT(*), entity_id, status
FROM refresh_state
WHERE next_update_at < NOW() - INTERVAL '7 days'
  AND (last_discovery_at < NOW() - INTERVAL '7 days' OR last_discovery_at IS NULL)
GROUP BY entity_id, status;




-- DELETE entities with errors that are very old and not being processed
DELETE FROM refresh_state 
WHERE errors IS NOT NULL 
  AND next_update_at < NOW() - INTERVAL '30 days'
  AND last_discovery_at < NOW() - INTERVAL '30 days'
LIMIT 5000; -- Start with a small batch
